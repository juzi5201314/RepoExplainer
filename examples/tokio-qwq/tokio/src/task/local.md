### 文件说明：tokio/src/task/local.rs

#### 目的
该文件实现了 Tokio 的 `LocalSet` 功能，用于在单线程环境中运行 `!Send` 的异步任务。它允许在不满足 `Send` 特性约束的异步任务（如依赖 `Rc` 或 `RefCell` 的数据）安全地运行，同时保持 Tokio 的异步执行模型。

---

#### 核心组件

1. **`LocalSet` 结构体**
   - **功能**：管理一组在单线程上执行的本地任务。
   - **关键字段**：
     - `context`: 线程本地状态，包含共享状态引用。
     - `shared`: 跨线程共享的状态，包括任务队列和唤醒机制。
     - `_not_send`: 确保 `LocalSet` 本身不实现 `Send` 特性。

2. **任务调度机制**
   - **本地队列 (`local_queue`)**：存储当前线程的任务。
   - **远程队列 (`queue`)**：用于其他线程通知任务。
   - **唤醒 (`AtomicWaker`)**：当有新任务加入时唤醒调度循环。

3. **任务管理**
   - **`spawn_local` 方法**：在 `LocalSet` 上启动 `!Send` 任务，确保任务仅在创建线程运行。
   - **`run_until` 方法**：驱动任务执行直到指定的 Future 完成，但保留未完成的本地任务。
   - **`Future` 实现**：`LocalSet` 自身可作为 Future，等待所有任务完成。

4. **线程安全与所有权**
   - **`LocalState`**：确保任务仅由创建线程访问，通过 `ThreadId` 校验。
   - **`UnsafeCell` 和原子操作**：在不违反 Rust 安全规则的前提下，管理共享状态。

---

#### 关键功能

1. **非 `Send` 任务支持**
   ```rust
   task::spawn_local(async { /* 使用 Rc 的代码 */ });
   ```
   允许在 `LocalSet` 内部安全运行依赖线程局部数据的任务。

2. **任务调度策略**
   - **轮询机制 (`tick` 方法)**：每次调度最多处理 `MAX_TASKS_PER_TICK` 个任务，避免单任务阻塞。
   - **队列切换**：每 `REMOTE_FIRST_INTERVAL` 次轮询检查远程队列，平衡任务分布。

3. **错误处理**
   - **未处理的 panic**：通过 `unhandled_panic` 配置决定是否终止整个 LocalSet。

4. **生命周期管理**
   - **`Drop` 实现**：清理未完成任务，确保资源释放。

---

#### 项目中的角色
该文件是 Tokio 异步执行框架的核心组件之一，提供对非 `Send` 任务的支持，扩展了异步编程的灵活性。它允许开发者在单线程上下文中安全地使用线程局部数据，同时保持 Tokio 的异步特性，是处理复杂状态管理场景（如依赖 `Rc` 的对象）的关键模块。

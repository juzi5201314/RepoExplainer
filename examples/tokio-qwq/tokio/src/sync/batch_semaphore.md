### 文件说明：`batch_semaphore.rs`

#### 目的
该文件实现了 Tokio 的批处理信号量（Batch Semaphore），用于在异步环境中管理资源访问。信号量通过原子计数器和等待队列实现，支持批量获取许可，并保证公平性（先到先得），防止任务饥饿。

---

#### 核心组件

1. **Semaphore 结构体**
   - **permits**: 原子计数器，记录当前可用许可数。最低有效位（CLOSED 标志位）标记信号量是否已关闭。
   - **waiters**: 使用 `Mutex` 保护的等待队列（`Waitlist`），包含：
     - `queue`: 基于 intrusive linked list 的等待者队列（FIFO）
     - `closed`: 标记信号量是否已关闭
   - **Tracing 支持**: 可选的跟踪功能（依赖 `tokio_unstable` 和 `tracing` 特性）

2. **Waiter 结构体**
   - 表示等待许可的任务：
     - `state`: 原子计数器，记录任务仍需的许可数
     - `waker`: 任务的唤醒器（需在等待队列加锁时访问）
     - `pointers`: 链表节点指针（intrusive list 的实现依赖）
     - `PhantomPinned`: 确保 `Waiter` 不可移动（因指针依赖固定地址）

3. **Acquire 结构体**
   - 实现 `Future` 特征，用于异步获取许可：
     - `node`: 对应的 `Waiter` 节点
     - `queued`: 标记任务是否已加入等待队列
     - `semaphore`: 引用目标信号量
     - `num_permits`: 需要获取的许可数

---

#### 核心逻辑

1. **许可获取 (`acquire` 方法)**
   - 尝试立即获取许可：若可用许可足够，直接扣除并返回成功。
   - 否则，将任务的 `Waiter` 节点加入队列尾部，并注册其 `Waker`。
   - 公平性保证：等待队列按 FIFO 处理，即使任务需要大量许可也不会被后续小请求抢占。

2. **许可释放 (`release` 方法)**
   - 将新增许可逐一分配给队列头部的等待者，直到许可耗尽或队列为空。
   - 若剩余许可，将其返还给信号量的可用计数器。

3. **信号量关闭 (`close` 方法)**
   - 标记信号量为关闭状态，并唤醒所有等待者，返回 `TryAcquireError::Closed`。

4. **等待队列管理 (`add_permits_locked` 函数)**
   - 核心逻辑：循环分配许可给队列中的等待者，优先满足队列头部的任务。
   - 使用 `WakeList` 批量唤醒已满足条件的任务，减少唤醒开销。

---

#### 公平性机制
- **FIFO 队列**: 等待者按加入顺序排列，确保先到先得。
- **批量许可处理**: 即使任务请求大量许可，仍按队列顺序处理，避免饥饿。例如，在读写锁场景中，写者不会被连续的读者阻塞。

---

#### 与 Tokio 项目的集成
该文件是 Tokio 同步模块的核心组件，提供：
- **资源控制**: 限制并发访问共享资源（如数据库连接池）。
- **异步友好**: 通过 `Future` 集成 Tokio 的任务调度系统。
- **可扩展性**: 支持高并发场景下的高效许可分配与回收。

---

#### 该文件在项目中的角色
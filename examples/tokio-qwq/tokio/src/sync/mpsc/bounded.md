# 代码文件解释：`tokio/src/sync/mpsc/bounded.rs`

## 目的  
此文件实现了 Tokio 中的 **有界多生产者单消费者（MPSC）通道**。有界通道通过限制缓冲区大小提供背压机制，确保生产者在缓冲区满时等待，防止内存无限制增长。

---

## 核心组件与功能

### 1. **Sender 结构体**
- **功能**：向关联的 Receiver 发送值。
- **关键特性**：
  - 使用 `Semaphore` 管理通道容量，确保缓冲区不超过指定大小。
  - 提供 `send` 方法异步发送消息，当缓冲区满时阻塞。
  - 支持通过 `reserve` 和 `try_reserve` 预留发送槽位，避免直接发送时的竞争。
  - 可通过 `downgrade` 转换为 `WeakSender`，不阻止通道关闭。

### 2. **WeakSender 结构体**
- **功能**：不参与通道关闭的弱发送端。
- **关键特性**：
  - 当所有 `Sender` 被丢弃且仅剩 `WeakSender` 时，通道关闭。
  - 通过 `upgrade` 尝试恢复为 `Sender`，若存在活跃的 `Sender` 则成功。

### 3. **Permit 和 OwnedPermit**
- **功能**：保证发送容量的预留凭证。
- **关键特性**：
  - `Permit` 通过 `send` 方法发送消息，释放预留槽位。
  - `OwnedPermit` 移动 `Sender` 所有权，支持 `'static` 生命周期场景。
  - 若未使用 `Permit` 直接丢弃，预留容量会自动释放。

### 4. **Receiver 结构体**
- **功能**：从通道接收值。
- **关键特性**：
  - 提供 `recv` 异步接收消息，缓冲区空时阻塞。
  - 支持 `try_recv` 非阻塞尝试接收。
  - 可通过 `close` 手动关闭通道，但允许接收剩余缓冲消息。
  - 提供 `is_closed`、`len` 等方法查询通道状态。

### 5. **channel 函数**
- **功能**：创建有界通道。
- **关键特性**：
  - 参数 `buffer` 指定缓冲区大小，必须 ≥1，否则 panic。
  - 返回 `(Sender<T>, Receiver<T>)`，支持多生产者单消费者模式。

---

## 实现细节

### 容量管理
- **Semaphore 机制**：通过 `batch_semaphore` 实现容量控制，`Sender` 在发送前需获取许可。
- **预留机制**：`reserve` 方法异步获取许可，`Permit` 确保发送时容量可用，避免竞争。

### 关闭与状态检查
- **通道关闭**：当所有 `Sender` 被丢弃或 `Receiver` 调用 `close`，通道关闭，但允许接收剩余消息。
- **状态查询**：`is_closed`、`is_empty`、`capacity` 等方法提供通道状态的实时信息。

### 取消安全性
- **send 和 reserve 的取消安全**：若在 `select!` 中中断，未完成的发送不会占用槽位，避免资源泄漏。

---

## 项目中的角色  
此文件是 Tokio 异步通信的核心组件，实现 **有界 MPSC 通道**，提供带缓冲区限制的可靠消息传递，确保生产者与消费者之间的资源平衡，是构建高并发异步应用的基础工具。

### 文件目的
该文件是 Tokio 多线程调度器的核心实现，负责管理 worker 线程的运行、任务调度、资源管理和运行时关闭逻辑。每个 worker 线程通过其核心（Core）维护本地任务队列和其他运行状态，并支持在阻塞操作时将核心转移给新线程以保持调度器的持续运行。

---

### 核心组件
#### 1. **Worker 结构**
- **Worker**: 表示一个 worker 线程，包含：
  - `handle`: 调度器的共享句柄
  - `core`: 通过 `AtomicCell` 管理的核心数据（`Core`）
  - `index`: worker 在调度器中的索引

#### 2. **Core 结构**
核心数据包含：
- **任务队列**:
  - `run_queue`: 本地任务队列
  - `lifo_slot`: 最后调度任务的 LIFO 优化槽（提升局部性）
- **状态标志**:
  - `is_shutdown`: 是否正在关闭
  - `is_searching`: 是否在寻找任务
  - `lifo_enabled`: 是否启用 LIFO 槽
- **统计与随机数**:
  - `stats`: 运行时统计信息
  - `rand`: 快速随机数生成器（用于任务窃取策略）

#### 3. **Shared 结构**
共享状态，所有 worker 共享：
- **任务队列与集合**:
  - `inject`: 全局注入队列（非 worker 线程提交任务）
  - `owned`: 所有活动任务的集合
- **关闭与跟踪**:
  - `shutdown_cores`: 关闭时收集的 core 列表
  - `trace_status`: 跟踪状态
- **配置与指标**:
  - `config`: 调度器配置
  - `scheduler_metrics`: 调度器级指标

#### 4. **Context 结构**
线程本地上下文，包含：
- `worker`: 当前 worker 引用
- `core`: 当前 core 的可变引用（通过 `RefCell` 管理）
- `defer`: 延迟唤醒的任务列表

---

### 核心逻辑
#### 1. **任务调度与执行**
- **LIFO 优化**:
  - 新调度的任务优先放入 `lifo_slot`，提升消息传递模式下的局部性和延迟。
  - 每次循环优先检查 `lifo_slot`，再检查本地队列。
- **任务窃取**:
  - 当本地队列为空时，从其他 worker 的队列窃取任务（随机选择目标 worker）。
  - 限制同时窃取的 worker 数量，避免资源竞争。

#### 2. **阻塞操作处理 (`block_in_place`)**:
- 将当前 worker 的核心转移给新线程，允许原线程阻塞：
  1. 从上下文中取出 core 并存入 worker。
  2. 在新线程中运行 worker 的 `run` 方法。
  3. 阻塞操作完成后，尝试重新获取核心。

#### 3. **运行时关闭流程**
- **步骤**:
  1. 调用 `Shared::close` 关闭注入队列和任务集合，唤醒所有 worker。
  2. 每个 worker 检测到关闭信号后，清空 `OwnedTasks`。
  3. 将 core 推入 `Shared::shutdown_cores`，最后一个 worker 完成最终清理：
     - 清空本地队列和注入队列。
     - 关闭资源（如 I/O 驱动）。
  4. 确保所有任务被终止，避免内存泄漏。

#### 4. **工作窃取与线程管理**
- **线程状态管理**:
  - `is_searching`: 标记是否在寻找任务。
  - `park`/`unpark`: 线程空闲时休眠，有任务时唤醒。
- **全局队列轮询**:
  每隔固定间隔从全局队列获取任务，平衡负载。

---

### 关键机制
#### 1. **LIFO 优化**
通过优先执行 `lifo_slot` 中的任务，减少消息传递的延迟。当任务数超过阈值 `MAX_LIFO_POLLS_PER_TICK`（默认 3）时，禁用 LIFO 槽以避免任务饥饿。

#### 2. **任务窃取策略**
- 随机选择目标 worker，减少竞争。
- 仅当不足半数 worker 在窃取时才允许新 worker 加入，避免资源浪费。

#### 3. **关闭时的任务处理**
- **两种情况**:
  1. 任务在 `OwnedTasks` 关闭前提交：由关闭流程清理。
  2. `OwnedTasks` 已关闭：直接取消任务，避免注入队列泄漏。

#### 4. **统计与调优**
- `stats` 记录任务处理、队列使用等指标。
- 动态调整全局队列轮询间隔（`global_queue_interval`），优化性能。

---

### 在项目中的角色
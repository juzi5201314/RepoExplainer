# 文件说明：`tokio/src/runtime/task/list.rs`

## 目的  
该文件定义了 Tokio 运行时中用于存储调度器上创建的任务的容器。主要包含以下两种容器类型：
1. **`OwnedTasks`**：线程安全的容器，仅能存储实现了 `Send` 特性的任务。
2. **`LocalOwnedTasks`**：非线程安全的容器，支持存储非 `Send` 任务。

这两个容器在运行时关闭时可通过关闭操作阻止新任务的添加，确保安全终止。

---

## 核心组件与功能

### 1. **任务 ID 管理**
- **唯一 ID 分配**：通过原子操作生成全局唯一的 `NonZeroU64` 类型 ID（`get_next_id`），用于标识每个容器实例。
- **所有权验证**：通过 `header().get_owner_id()` 检查任务是否属于当前容器，确保任务仅被正确容器处理。

### 2. **`OwnedTasks` 结构**
- **线程安全的分片列表**：使用 `sharded_list::ShardedList` 实现分片锁机制，减少高并发下的锁竞争。分片数量通过 `gen_shared_list_size` 根据 CPU 核心数动态计算。
- **任务绑定与关闭**：
  - `bind` 方法将任务绑定到容器，设置所有权 ID，并检查容器是否已关闭。
  - `close_and_shutdown_all` 关闭容器并终止所有任务，通过分片遍历确保高效清理。
- **任务操作**：
  - `remove` 安全移除任务。
  - `assert_owner` 验证任务所有权并转换为可本地调度的 `LocalNotified`。

### 3. **`LocalOwnedTasks` 结构**
- **单线程列表**：使用 `LinkedList` 存储任务，通过 `UnsafeCell` 实现内部可变性，但不保证 `Sync`。
- **本地绑定与关闭**：
  - `bind` 方法直接操作内部列表，无需分片。
  - `close_and_shutdown_all` 顺序遍历列表终止任务。
- **非线程安全约束**：通过 `PhantomData` 标记确保不被跨线程使用。

### 4. **关闭与清理机制**
- **关闭标志**：通过 `AtomicBool` 或 `bool` 标记容器是否已关闭，阻止新任务添加。
- **任务终止**：调用 `task.shutdown()` 强制任务退出，确保资源释放。

---

## 关键技术细节
- **分片锁优化**：`OwnedTasks` 的 `ShardedList` 通过分片减少锁竞争，平衡内存连续性和性能。
- **所有权验证**：通过 ID 检查确保任务仅由所属容器操作，避免跨容器误操作。
- **原子操作**：ID 分配和关闭标志使用原子操作保证线程安全。

---

## 在项目中的角色  
该文件是 Tokio 运行时任务管理的核心组件，负责任务的存储、调度、生命周期控制以及安全关闭。通过区分线程安全与非线程安全容器，支持异步任务的高效调度和资源管理，是 Tokio 异步执行模型的基础实现之一。

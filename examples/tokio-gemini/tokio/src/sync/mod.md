这个文件 `tokio/src/sync/mod.rs` 包含了 Tokio 异步编程中使用的同步原语。它的主要目的是提供在异步上下文环境中使用的各种同步机制，允许独立的 Tokio 任务进行通信和协作。

**主要组成部分：**

1.  **模块文档和概述：**
    *   文件首先介绍了 Tokio 程序中同步的重要性，强调了任务之间的独立性和通过消息传递进行同步的优势。
    *   它概述了 Tokio 提供的不同类型的通道，并解释了它们各自的用途和特点。
    *   文档中包含了大量的代码示例，展示了如何使用不同的同步原语来解决实际问题。

2.  **通道（Channels）：**
    *   **`oneshot` 通道：** 用于在单个生产者和一个消费者之间传递单个值，常用于获取计算结果。
    *   **`mpsc` 通道：** 支持多个生产者向单个消费者发送多个值，适用于任务间的工作分配和结果收集。
    *   **`broadcast` 通道：** 支持多个生产者向多个消费者广播消息，常用于实现发布/订阅模式。
    *   **`watch` 通道：** 类似于广播通道，但只存储最新的值，适用于配置更新或状态变化通知。

3.  **状态同步原语：**
    *   **`Barrier`：** 确保多个任务等待彼此到达某个点，然后一起继续执行。
    *   **`Mutex`：** 互斥锁，用于保护共享数据，确保一次只有一个任务可以访问。
    *   **`Notify`：** 基本的任务通知机制，用于唤醒等待的任务。
    *   **`RwLock`：** 读写锁，允许多个读者同时访问，但只允许一个写者访问。
    *   **`Semaphore`：** 信号量，用于限制并发数量。

4.  **运行时兼容性：**
    *   说明了这些同步原语是运行时无关的，可以在不同的 Tokio 运行时或非 Tokio 运行时中使用。
    *   当在 Tokio 运行时中使用时，它们参与协作调度以避免饥饿。
    *   `*_timeout` 结尾的方法是例外，因为它们需要访问 Tokio 计时器。

5.  **模块结构：**
    *   使用 `cfg_sync!` 和 `cfg_not_sync!` 宏来根据编译配置选择性地包含不同的模块。
    *   定义了 `futures` 模块，用于导出命名的 future 类型。
    *   包含了各种同步原语的模块，如 `barrier`, `broadcast`, `mpsc`, `mutex`, `notify`, `oneshot`, `semaphore`, `rwlock`, `watch` 等。
    *   包含了 `task` 模块，用于提供 `AtomicWaker`。
    *   包含了 `once_cell` 模块，用于提供 `OnceCell`。
    *   包含了测试模块 `tests`。

**与其他文件的关系：**

*   这个文件是 Tokio 库中同步原语的入口点，其他模块会引用和使用这里定义的类型和功能。
*   它与 `crate::task` 模块紧密相关，因为同步原语用于任务间的通信和协作。
*   它还与 `crate::loom` 模块交互，用于提供线程安全和并发相关的底层支持。

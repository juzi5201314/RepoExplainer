这个文件实现了一个基于 Tokio 的聊天服务器，它允许连接的客户端相互发送消息。以下是该文件的详细解释：

**目的:**

该文件旨在创建一个简单的聊天服务器，演示如何使用 Tokio 处理并发连接和消息广播。它允许客户端通过 telnet 连接到服务器，并与其他连接的客户端进行实时聊天。

**关键组件:**

1.  **依赖项:**
    *   `tokio`: 用于异步 I/O 操作和并发处理。
    *   `tokio::net`: 提供 TCP 监听器和流。
    *   `tokio::sync`: 用于线程间通信的通道和互斥锁。
    *   `tokio_stream`: 用于处理异步流。
    *   `tokio_util::codec`: 提供用于编码和解码文本行的 `LinesCodec`。
    *   `futures`: 提供异步编程的实用工具。
    *   `std::collections::HashMap`: 用于存储客户端地址和发送通道。
    *   `std::sync::Arc`: 用于在多个线程之间共享数据。
    *   `std::sync::Mutex`: 用于保护共享数据的并发访问。
    *   `tracing_subscriber`: 用于日志记录。

2.  **`Shared` 结构体:**
    *   包含一个 `HashMap`，用于存储每个连接客户端的套接字地址 (`SocketAddr`) 和发送通道 (`Tx`)。
    *   `broadcast` 方法用于将消息发送给除了发送者之外的所有客户端。

3.  **`Peer` 结构体:**
    *   表示单个连接的客户端。
    *   包含一个 `Framed<TcpStream, LinesCodec>`，用于处理与客户端的通信，使用 `LinesCodec` 按行读取和写入数据。
    *   包含一个接收通道 (`Rx`)，用于接收来自其他客户端的消息。

4.  **`main` 函数:**
    *   初始化 `tracing` 日志记录。
    *   创建一个共享状态 (`Shared`)，用于存储所有客户端的连接信息。
    *   创建一个 TCP 监听器 (`TcpListener`)，监听指定的地址和端口。
    *   在一个循环中，异步接受传入的连接。
    *   为每个新连接创建一个新的任务 (`tokio::spawn`)，调用 `process` 函数处理客户端。

5.  **`process` 函数:**
    *   处理单个客户端的连接。
    *   使用 `LinesCodec` 包装 TCP 流，以便按行读取和写入数据。
    *   提示客户端输入用户名。
    *   创建 `Peer` 实例，将客户端添加到共享状态。
    *   广播客户端加入聊天室的消息。
    *   在一个循环中，处理来自客户端的消息和来自其他客户端的消息。
    *   当客户端发送消息时，广播消息给其他客户端。
    *   当客户端断开连接时，从共享状态中移除客户端，并广播客户端离开聊天室的消息。

6.  **通道 (`Tx`, `Rx`):**
    *   使用 `mpsc::unbounded_channel` 创建无界通道，用于在客户端之间传递消息。
    *   `Tx` 是发送端，用于将消息发送到通道。
    *   `Rx` 是接收端，用于从通道接收消息。

**工作流程:**

1.  服务器启动并监听指定的地址和端口。
2.  客户端使用 telnet 连接到服务器。
3.  服务器为每个连接创建一个新的任务。
4.  客户端输入用户名。
5.  服务器将客户端添加到共享状态。
6.  客户端发送消息。
7.  服务器接收消息，并广播给其他客户端。
8.  其他客户端接收消息并显示。
9.  客户端断开连接。
10. 服务器从共享状态中移除客户端，并广播客户端离开的消息。

**与其他文件/项目的关系:**

这个文件是一个独立的示例，展示了如何使用 Tokio 构建一个简单的聊天服务器。它没有与其他文件直接关联，但可以作为更复杂项目的构建块。
